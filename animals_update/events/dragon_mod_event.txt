#######dragon update
### event 198 - 

namespace = ani_plus

#### event 198 and 199 are created to prevent dragon character from changing culture
#### at the exception where an egg can become an adult
## event 198: on_action trigger, switch back to old culture if old is dragon
## event 199: exits only to avoid an infinite loop if old and new culture are both adult dragon

# event 198 - preventing dragon to change culture (race)
#               except for switch between dragon egg and adult dragon
character_event = {
    id = ani_plus.198

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_character_flag = ignore_next_dragon_conv }
    }

    immediate = {
        # had to do tests with a new character becaus engine did not let me do
        # any test on culture scope
        create_character = {
            culture = FROM
            female = random
        }

        if = {
            limit = {
                new_character = { # was dragon
                    culture_group = dragon_group
                }
                NAND = {          # not adult yet
                    new_character = {
                        culture = dragon_culture
                    }
                    ROOT = {
                        culture_group = dragon_group
                        is_adult = yes
                    }
                }
                NAND = {         # not at birth or game start
                    new_character = {
                        NOT = { culture = dragon_culture }
                    }
                    ROOT = {
                        culture = dragon_culture
                        is_adult = no
                    }
                }
            }
            set_character_flag = ignore_next_dragon_conv
            culture = FROM

            character_event = { id = ani_plus.199 days = 1}
        }

        new_character = {
            death = yes
        }
    }
}

# event 199
character_event = {
    id = ani_plus.199

    hide_window = yes
    is_triggered_only = yes

    immediate = {
        clr_character_flag = ignore_next_dragon_conv
    }
}

#### event 200 to 201: religious event force religion setting
## event 200: setting holy site randomly (on game start, event if random always choose the same provinces)
## event 201: setting character and province in game start by
#                   forcing dragon religion
#                   setting egg culture for dragon egg
#                   giving adult dragon their flag
## event 202: converting character on birth or culture change
## event 203: converting province culture on religion change


# event 200
character_event = {
    id = ani_plus.200

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_global_flag = dragon_holy_sites_set }
    }

    immediate = {
        set_black_dragon_holy_site_effect = yes
        set_white_dragon_holy_site_effect = yes
        set_red_dragon_holy_site_effect = yes
        set_blue_dragon_holy_site_effect = yes
        set_yellow_dragon_holy_site_effect = yes
    }

    after = {
        set_global_flag = dragon_holy_sites_set
    }
}

# event 201
character_event = {
    id = ani_plus.201

    hide_window = yes
    is_triggered_only = yes

    immediate = {
        any_character = {
            limit = {
                culture_group = dragon_group
                can_change_religion = yes
            }
            religion = Dragon_religion
            dragon_get_dragon_egg_culture_if_child_effect = yes
            dragon_get_true_adult_effect = yes
        }
        any_province = {
            limit = {
                culture_group = dragon_group
            }
            religion = Dragon_religion
        }
    }
}

# event 202
character_event = {
    id = ani_plus.202

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture_group = dragon_group
        can_change_religion = yes
        NOT = { religion = Dragon_religion }
    }

    immediate = {
        religion = Dragon_religion
    }
}

# event 203
province_event = {
    id = ani_plus.203

    hide_window = yes
    
    trigger = {
        culture_group = dragon_group
        NOT = {
            religion = Dragon_religion
        }
    }

    mean_time_to_happen = {
        months = 1
    }

    immediate = {
        if = {
            limit = {
                holder_scope = {
                    culture_group = dragon_group
                }
            }

            religion = Dragon_religion
        }
        else = {
            culture = holder_scope
        }
    }
}

# event 204: force looting from a baronny title
province_event = {
    id = ani_plus.204

    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ani_204

    trigger = {
        culture_group = dragon_group
        holder_scope = {
            culture_group = dragon_group
        }

        county = {
            is_occupied = no
            any_de_jure_vassal_title = {
                OR = {
                    holding_type = castle
                    holding_type = city
                    holding_type = temple
                }
            }
        }
    }

    mean_time_to_happen = {
        months = 2

        modifier = {
            factor = 100

            holder_scope = {
                culture = dragon_culture
            }
        }
    }

    option = {
        name = OPT_ani_204

        county = {
            show_scope_change = no
            random_direct_de_jure_vassal_title = {
                limit = {
                    OR = {
                        holding_type = castle
                        holding_type = city
                        holding_type = temple
                    }
                }

                if = {
                    limit = {
                        has_any_building = yes
                    }

                    destroy_random_building = yes
                }
                else = {
                    destroy_settlement = yes
                }
            }

            holder_scope = {
                wealth = 200
            }
        }
    }
}

#### event 205 to 218 : dragon education events
## event 205: hidden event for adulthood (to show parent player)
## event 206: notification for culture change
#               and removing education trait (if conclave is disable)
#                   as education trait will be added after passing the 5 trials
## event 207: trial tombola for dragon
## event 208-209: snow trial
## event 210-211: fire trial
## event 212-213: water trial
## event 214-215: sand trial
## event 216-217: poison trial
## event 218: conclusion (give education trait and intelligence trait)

# event 205
character_event = {
    id = ani_plus.205

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture = dragon_culture
    }

    immediate = {
        if = {
            limit = {
                father = {
                    ai = no
                }
            }

            father = {
                character_event = { id = ani_plus.206 }
            }
        }
        else_if = {
            limit = {
                mother = {
                    ai = no
                }
            }
            
            mother = {
                character_event = { id = ani_plus.206 }
            }
        }
        else = {
            character_event = { id = ani_plus.206 }
        }
    }
}

# event 206
character_event = {
    id = ani_plus.206

    is_triggered_only = yes

    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council
    desc = {
        trigger = {
            NOT = { character = FROM }
        }
        text = DESCA_ANI_206
    }
    desc = {
        trigger = {
            character = FROM
        }
        text = DESCB_ANI_206
    }

    option = {
        name = {
            text = OPTA_ANI_206
            trigger = {
                NOT = { character = FROM }
            }
        }

        FROM = {
            #removing education trait if conclave DLC disabled
            hidden_tooltip = {
                generate_tooltip = no

                remove_trait = amateurish_plotter
                remove_trait = flamboyant_schemer
                remove_trait = intricate_webweaver
                remove_trait = elusive_shadow

                remove_trait = naive_appeaser
                remove_trait = underhanded_rogue
                remove_trait = charismatic_negotiator
                remove_trait = grey_eminence

                remove_trait = indulgent_wastrel
                remove_trait = thrifty_clerk
                remove_trait = fortune_builder
                remove_trait = midas_touched

                remove_trait = misguided_warrior
                remove_trait = tough_soldier
                remove_trait = skilled_tactician
                remove_trait = brilliant_strategist

                remove_trait = detached_priest
                remove_trait = martial_cleric
                remove_trait = scholarly_theologian
                remove_trait = mastermind_theologian
            }

            random_list = {
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = white_dragon_potential
                        }
                    }
                    
                    culture = white_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = black_dragon_potential
                        }
                    }

                    culture = black_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = blue_dragon_potential
                        }
                    }

                    culture = blue_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = red_dragon_potential
                        }
                    }

                    culture = red_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = yellow_dragon_potential
                        }
                    }

                    culture = yellow_dragon
                }
            }
            clr_character_flag = white_dragon_potential
            clr_character_flag = black_dragon_potential
            clr_character_flag = blue_dragon_potential
            clr_character_flag = red_dragon_potential
            clr_character_flag = yellow_dragon_potential
        }
    }
}

# event 207
character_event = {
    id = ani_plus.207

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture_group = dragon_group
        NOT = { culture = dragon_culture } # not an egg
        NOT = { has_character_flag = is_true_dragon_adult }
        war = no
    }

    immediate = {
        random_list = {
            1 = { # snow trial
                trigger = {
                    NOT = {
                        has_character_flag = snow_trial_realized
                    }
                }
                set_character_flag = snow_trial_realized
                character_event = { id = ani_plus.208 }
            }
            1 = { # fire trial
                trigger = {
                    NOT = {
                        has_character_flag = fire_trial_realized
                    }
                }
                set_character_flag = fire_trial_realized
                character_event = { id = ani_plus.210 }
            }
            1 = { # water trial
                trigger = { always = no }
            }
            1 = { # sand trial
                trigger = { always = no }
            }
            1 = { # poison trial
                trigger = { always = no }
            }
            fallback  = {
                if = {
                    limit = {
                        father = {
                            ai = no
                        }
                    }
                    father = {
                        character_event = { id = ani_plus.218 }
                    }
                }
                else_if = {
                    limit = {
                        mother = {
                            ai = no
                        }
                    }
                    mother = {
                        character_event = { id = ani_plus.218 }
                    }
                }
                else = {
                    character_event = { id = ani_plus.218 }
                }
            }
        }
    }
}

# event 208
character_event = {
    id = ani_plus.208

    is_triggered_only = yes
    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ANI_208

    option = {
        name = OPTA_ANI_208
        set_character_flag = dragon_snow_normal
        
        ai_chance = {
            factor = 10
            
            dragon_trial_choice_1_score = yes
        }
    }
    option = {
        name = OPTB_ANI_208
        set_character_flag = dragon_snow_hard

        ai_chance = {
            factor = 10

            dragon_trial_choice_2_score = yes
        }
    }
    option = {
        name = OPTC_ANI_208
        set_character_flag = dragon_snow_all_for_all

        ai_chance = {
            factor = 10

            dragon_trial_choice_3_score = yes
        }
    }
    option = {
        name = OPTD_ANI_208
        set_character_flag = dragon_snow_safe

        ai_chance = {
            factor = 10

            dragon_trial_choice_4_score = yes
        }
    }

    after = {
        hidden_tooltip = {
            random_list = {

                40 = {
                    trigger = {
                        NOT = {
                            has_character_flag = dragon_snow_safe
                        }
                    }
                    modifier = {
                        factor = 0.80
                        has_character_flag = dragon_snow_normal
                    }
                    modifier = {
                        factor = 1.5
                        learning = 5
						NOT = { learning = 10}
                    }
                    modifier = {
                        factor = 0.5
                        NAND = {
                            learning = 2
                            culture = white_dragon
                        }
                    }
                    modifier = {
                        factor = 1.25
                        trait = lustful
                    }
                    modifier = {
                        factor = 1.25
                        trait = slothful
                    }
                    modifier = {
                        factor = 1.5
                        trait = zealous
                    }
                    set_character_flag = dragon_snow_level_1
                }
                40 = {
                    trigger = {
                        NOT = {
                            has_character_flag = dragon_snow_all_for_all
                        }
                    }
                    modifier = {
                        factor = 0.80
                        has_character_flag = dragon_snow_normal
                    }
                    modifier = {
                        factor = 2
                        learning = 10
						NOT = { learning = 15}
                    }
                    modifier = {
                        factor = 0.5
                        NAND = {
                            learning = 5
                            culture = white_dragon
                        }
                    }
                    modifier = {
                        factor = 1.25
                        trait = envious
                    }
                    modifier = {
                        factor = 1.25
                        trait = proud
                    }
                    modifier = {
                        factor = 1.25
                        trait = zealous
                    }
                    set_character_flag = dragon_snow_level_2
                }
                40 = {
                    trigger = {
                        NOR = {
                            has_character_flag = dragon_snow_hard
                            has_character_flag = dragon_snow_all_for_all
                        }
                    }
                    modifier = {
                        factor = 2
                        learning = 15
						NOT = { learning = 20 }
                    }
                    modifier = {
                        factor = 0.5
                        NAND = {
                            learning = 10
                            culture = white_dragon
                        }
                    }
                    modifier = {
                        factor = 1.25
                        trait = chaste
                    }
                    modifier = {
                        factor = 1.5
                        trait = erudite
                    }
                    set_character_flag = dragon_snow_level_3
                }
                40 = {
                    trigger = {
                        NOR = {
                            has_character_flag = dragon_snow_normal
                            has_character_flag = dragon_snow_safe
                        }
                    }
                    modifier = {
                        factor = 2
                        learning = 20
                    }
                    modifier = {
                        factor = 0.5
                        NAND = {
                            learning = 15
                            culture = white_dragon
                        }
                    }
                    modifier = {
                        factor = 1.25
                        trait = humble
                    }
                    modifier = {
                        factor = 1.5
                        trait = erudite
                    }
                    set_character_flag = dragon_snow_level_4
                }
            }

            clr_character_flag = dragon_snow_normal
            clr_character_flag = dragon_snow_hard
            clr_character_flag = dragon_snow_all_for_all
            clr_character_flag = dragon_snow_safe

            character_event = { id = ani_plus.209 }
        }
    }
}

# event 209
character_event = {
    id = ani_plus.209

    is_triggered_only = yes
    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ANI_209

    option = {
        name = OPTA_ANI_209
        trigger = {
            has_character_flag = dragon_snow_level_1
        }

        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 1
            }
        }
    }
    option = {
        name = OPTB_ANI_209
        trigger = {
            has_character_flag = dragon_snow_level_2
        }
        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 2
            }
        }
        
    }
    option = {
        name = OPTC_ANI_209
        trigger = {
            has_character_flag = dragon_snow_level_3
        }

        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 3
            }
        }
    }
    option = {
        name = OPTD_ANI_209
        trigger = {
            has_character_flag = dragon_snow_level_4
        }
        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 4
            }
        }
    }
}

# event 210
character_event = {
    id = ani_plus.210

    is_triggered_only = yes
    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ANI_210

	# option has same localisation as the first event
    option = {
        name = OPTA_ANI_208
        set_character_flag = dragon_fire_normal
        
        ai_chance = {
            factor = 10
            
            dragon_trial_choice_1_score = yes
        }
    }
    option = {
        name = OPTB_ANI_208
        set_character_flag = dragon_fire_hard

        ai_chance = {
            factor = 10

            dragon_trial_choice_2_score = yes
        }
    }
    option = {
        name = OPTC_ANI_208
        set_character_flag = dragon_fire_all_for_all

        ai_chance = {
            factor = 10

            dragon_trial_choice_3_score = yes
        }
    }
    option = {
        name = OPTD_ANI_208
        set_character_flag = dragon_fire_safe

        ai_chance = {
            factor = 10

            dragon_trial_choice_4_score = yes
        }
    }

	after = {
		hidden_tooltip = {
			random_list = {

				40 = {
					trigger = {
						NOT = {
							has_character_flag = dragon_fire_safe
						}
					}
					modifier = {
						factor = 0.80
						has_character_flag = dragon_fire_normal
					}
					modifier = {
						factor = 1.5
						martial = 5
						NOT = { martial = 10 } 
					}
					modifier = {
						factor = 0.5
						NAND = {
							martial = 2
							culture = red_dragon
						}
					}
					modifier = {
						factor = 1.5
						trait = chaste
					}
					modifier = {
						factor = 1.5
						trait = charitable
					}
					modifier = {
						factor = 4
						trait = gluttonous
					}
					modifier = {
						factor = 7
						trait = slothful
					}
					modifier = {
						factor = 1.25
						trait = deceitful
					}
					modifier = {
						factor = 1.1
						trait = shy
					}


					set_character_flag = dragon_fire_level_1
				}
				40 = {
					trigger = {
						NOT = {
							has_character_flag = dragon_fire_all_for_all
						}
					}
					modifier = {
						factor = 0.80
						has_character_flag = dragon_fire_normal
					}
					modifier = {
						factor = 2
						martial = 10
						NOT = { martial = 15}
					}
					modifier = {
						factor = 0.5
						NAND = {
							martial = 5
							culture = red_dragon
						}
					}
					modifier = {
						factor = 1.5
						trait = gluttonous
					}
					modifier = {
						factor = 2
						trait = slothful
					}
					modifier = {
						factor = 3
						trait = shy
					}
					modifier = {
						factor = 2
						trait = content
					}
					modifier = {
						factor = 1.3
						trait = arbitrary
					}
					
					set_character_flag = dragon_fire_level_2
				}
				40 = {
					trigger = {
						NOR = {
							has_character_flag = dragon_fire_hard
							has_character_flag = dragon_fire_all_for_all
						}
					}
					modifier = {
						factor = 2
						martial = 15
						NOT = { martial = 20 }
					}
					modifier = {
						factor = 0.5
						NAND = {
							martial = 10
							culture = red_dragon
						}
					}
					modifier = {
						factor = 2
						trait = content
					}
					modifier = {
						factor = 1.1
						trait = arbitrary
					}
					modifier = {
						factor = 3
						trait = wroth
					}
					modifier = {
						factor = 1.5
						trait = proud
					}
					modifier = {
						factor = 2
						trait = brave
					}
					modifier ={
						factor = 2
						trait = cruel
					}
					modifier = {
						factor = 1.3
						trait = stubborn
					}
					

					set_character_flag = dragon_fire_level_3
				}
				40 = {
					trigger = {
						NOR = {
							has_character_flag = dragon_fire_normal
							has_character_flag = dragon_fire_safe
						}
					}
					modifier = {
						factor = 2
						martial = 20
					}
					modifier = {
						factor = 0.5
						NAND = {
							martial = 15
							culture = red_dragon
						}
					}
					modifier = {
						factor = 2
						trait = wroth
					}
					modifier = {
						factor = 3
						trait = brave
					}
					modifier = {
						factor = 1.5
						trait = cruel
					}
					modifier = {
						factor = 1.1
						trait = diligent
					}

					set_character_flag = dragon_fire_level_4
                }
            }

            clr_character_flag = dragon_fire_normal
            clr_character_flag = dragon_fire_hard
            clr_character_flag = dragon_fire_all_for_all
            clr_character_flag = dragon_fire_safe

            character_event = { id = ani_plus.211 }
        }
    }
}

# event 211 - same loc as event 209
character_event = {
    id = ani_plus.211

    is_triggered_only = yes
    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ANI_209

    option = {
        name = OPTA_ANI_209
        trigger = {
            has_character_flag = dragon_fire_level_1
        }

        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 1
            }
        }
    }
    option = {
        name = OPTB_ANI_209
        trigger = {
            has_character_flag = dragon_fire_level_2
        }
        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 2
            }
        }
        
    }
    option = {
        name = OPTC_ANI_209
        trigger = {
            has_character_flag = dragon_fire_level_3
        }

        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 3
            }
        }
    }
    option = {
        name = OPTD_ANI_209
        trigger = {
            has_character_flag = dragon_fire_level_4
        }
        hidden_tooltip = {
            change_variable = {
                which = dragon_education_score
                value = 4
            }
        }
    }
}

# event 218
character_event = {
    id = ani_plus.218

    is_triggered_only = yes
    hide_window = yes # to act as a temporary event before implementation

    immediate = {
        FROM = {
            set_character_flag = is_true_dragon_adult



        }
    }
    after = {
        hidden_tooltip = {
            FROM = {
                # removing variable from save
                set_variable = {
                    which = dragon_education_score
                    value = 0
                }
            }
        }
    }
}
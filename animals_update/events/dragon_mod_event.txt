#######dragon update
### event 198 - 

namespace = ani_plus

#### event 198 and 199 are created to prevent dragon character from changing culture
#### at the exception where an egg can become an adult
## event 198: on_action trigger, switch back to old culture if old is dragon
## event 199: exits only to avoid an infinite loop if old and new culture are both adult dragon

# event 198 - preventing dragon to change culture (race)
#               except for switch between dragon egg and adult dragon
character_event = {
    id = ani_plus.198

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_character_flag = ignore_next_dragon_conv }
    }

    immediate = {
        # had to do tests with a new character becaus engine did not let me do
        # any test on culture scope
        create_character = {
            culture = FROM
            female = random
        }

        if = {
            limit = {
                new_character = { # was dragon
                    culture_group = dragon_group
                }
                NAND = {          # not adult yet
                    new_character = {
                        culture = dragon_culture
                    }
                    ROOT = {
                        culture_group = dragon_group
                        is_adult = yes
                    }
                }
                NAND = {         # not at birth or game start
                    new_character = {
                        NOT = { culture = dragon_culture }
                    }
                    ROOT = {
                        culture = dragon_culture
                        is_adult = no
                    }
                }
            }
            set_character_flag = ignore_next_dragon_conv
            culture = FROM

            character_event = { id = ani_plus.199 days = 1}
        }

        new_character = {
            death = yes
        }
    }
}

# event 199
character_event = {
    id = ani_plus.199

    hide_window = yes
    is_triggered_only = yes

    immediate = {
        clr_character_flag = ignore_next_dragon_conv
    }
}

#### event 200 to 201: religious event force religion setting
## event 200: setting holy site randomly (on game start, event if random always choose the same provinces)
## event 201: setting character and province in game start by
#                   forcing dragon religion
#                   setting egg culture for dragon egg
#                   giving adult dragon their flag
## event 202: converting character on birth or culture change
## event 203: converting province culture on religion change


# event 200
character_event = {
    id = ani_plus.200

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        NOT = { has_global_flag = dragon_holy_sites_set }
    }

    immediate = {
        set_black_dragon_holy_site_effect = yes
        set_white_dragon_holy_site_effect = yes
        set_red_dragon_holy_site_effect = yes
        set_blue_dragon_holy_site_effect = yes
        set_yellow_dragon_holy_site_effect = yes
    }

    after = {
        set_global_flag = dragon_holy_sites_set
    }
}

# event 201
character_event = {
    id = ani_plus.201

    hide_window = yes
    is_triggered_only = yes

    immediate = {
        any_character = {
            limit = {
                culture_group = dragon_group
                can_change_religion = yes
            }
            religion = Dragon_religion
            dragon_get_dragon_egg_culture_if_child_effect = yes
            dragon_get_true_adult_effect = yes
        }
        any_province = {
            limit = {
                culture_group = dragon_group
            }
            religion = Dragon_religion
        }
    }
}

# event 202
character_event = {
    id = ani_plus.202

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture_group = dragon_group
        can_change_religion = yes
        NOT = { religion = Dragon_religion }
    }

    immediate = {
        religion = Dragon_religion
    }
}

# event 203
province_event = {
    id = ani_plus.203

    hide_window = yes
    
    trigger = {
        culture_group = dragon_group
        NOT = {
            religion = Dragon_religion
        }
    }

    mean_time_to_happen = {
        months = 1
    }

    immediate = {
        if = {
            limit = {
                holder_scope = {
                    culture_group = dragon_group
                }
            }

            religion = Dragon_religion
        }
        else = {
            culture = holder_scope
        }
    }
}

# event 204: force looting from a baronny title
province_event = {
    id = ani_plus.204

    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council

    desc = DESC_ani_204

    trigger = {
        culture_group = dragon_group
        holder_scope = {
            culture_group = dragon_group
        }

        county = {
            is_occupied = no
            any_de_jure_vassal_title = {
                OR = {
                    holding_type = castle
                    holding_type = city
                    holding_type = temple
                }
            }
        }
    }

    mean_time_to_happen = {
        months = 2

        modifier = {
            factor = 100

            holder_scope = {
                culture = dragon_culture
            }
        }
    }

    option = {
        name = OPT_ani_204

        county = {
            show_scope_change = no
            random_direct_de_jure_vassal_title = {
                limit = {
                    OR = {
                        holding_type = castle
                        holding_type = city
                        holding_type = temple
                    }
                }

                if = {
                    limit = {
                        has_any_building = yes
                    }

                    destroy_random_building = yes
                }
                else = {
                    destroy_settlement = yes
                }
            }

            holder_scope = {
                wealth = 200
            }
        }
    }
}

#### event 205 to  : dragon education events
## event 205: hidden event for adulthood (to show parent player)
## event 206: notification for culture change
#               and removing education trait (if conclave is disable)
#                   as education trait will be added after passing the 5 trials
## event 207: trial tombola for dragon
## event 208-209: snow trial
## event 210-211: fire trial
## event 212-213: water trial
## event 214-215: sand trial
## event 216-217: poison trial
## event 218: conclusion (give education trait and intelligence trait)

# event 205
character_event = {
    id = ani_plus.205

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture = dragon_culture
    }

    immediate = {
        if = {
            limit = {
                father = {
                    ai = no
                }
            }

            father = {
                character_event = { id = ani_plus.206 }
            }
        }
        else_if = {
            limit = {
                mother = {
                    ai = no
                }
            }
            
            mother = {
                character_event = { id = ani_plus.206 }
            }
        }
        else = {
            character_event = { id = ani_plus.206 }
        }
    }
}

# event 206
character_event = {
    id = ani_plus.206

    is_triggered_only = yes

    border = GFX_event_normal_frame_diplomacy
    picture = GFX_evt_council
    desc = {
        trigger = {
            NOT = { character = FROM }
        }
        text = DESCA_ANI_206
    }
    desc = {
        trigger = {
            character = FROM
        }
        text = DESCB_ANI_206
    }

    option = {
        name = {
            text = OPTA_ANI_206
            trigger = {
                NOT = { character = FROM }
            }
        }

        FROM = {
            #removing education trait if conclave DLC disabled
            hidden_tooltip = {
                generate_tooltip = no

                remove_trait = amateurish_plotter
                remove_trait = flamboyant_schemer
                remove_trait = intricate_webweaver
                remove_trait = elusive_shadow

                remove_trait = naive_appeaser
                remove_trait = underhanded_rogue
                remove_trait = charismatic_negotiator
                remove_trait = grey_eminence

                remove_trait = indulgent_wastrel
                remove_trait = thrifty_clerk
                remove_trait = fortune_builder
                remove_trait = midas_touched

                remove_trait = misguided_warrior
                remove_trait = tough_soldier
                remove_trait = skilled_tactician
                remove_trait = brilliant_strategist

                remove_trait = detached_priest
                remove_trait = martial_cleric
                remove_trait = scholarly_theologian
                remove_trait = mastermind_theologian
            }

            random_list = {
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = white_dragon_potential
                        }
                    }
                    
                    culture = white_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = black_dragon_potential
                        }
                    }

                    culture = black_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = blue_dragon_potential
                        }
                    }

                    culture = blue_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = red_dragon_potential
                        }
                    }

                    culture = red_dragon
                }
                1 = {
                    modifier = {
                        factor = 0
                        NOT = {
                            has_character_flag = yellow_dragon_potential
                        }
                    }

                    culture = yellow_dragon
                }
            }
        }
    }
}

# event 207
character_event = {
    id = ani_plus.207

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        culture_group = dragon_group
        NOT = { culture = dragon_culture } # not an egg
        NOT = { has_character_flag = is_true_dragon_adult }
    }

    immediate = {
        random_list = {
            1 = {
                trigger = { always = no }
            }
            1 = {
                trigger = { always = no }
            }
            1 = {
                trigger = { always = no }
            }
            1 = {
                trigger = { always = no }
            }
            1 = {
                trigger = { always = no }
            }
            fallback  = {
                if = {
                    limit = {
                        father = {
                            ai = no
                        }
                    }
                    father = {
                        character_event = { id = ani_plus.218 }
                    }
                }
                else_if = {
                    limit = {
                        mother = {
                            ai = no
                        }
                    }
                    mother = {
                        character_event = { id = ani_plus.218 }
                    }
                }
                else = {
                    character_event = { id = ani_plus.218 }
                }
            }
        }
    }
}

# event 218
character_event = {
    id = ani_plus.218

    is_triggered_only = yes
    hide_window = yes # to act as a temporary event before implementation

    immediate = {
        FROM = {
            set_character_flag = is_true_dragon_adult
        }
    }
}